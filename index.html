<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="IDES Data Preparation - OpenSSL : Decrypting notifications received from IDES with OpenSSL">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>IDES Data Preparation - OpenSSL</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/IRSgov/IDES-Data-Preparation-OpenSSL">View on GitHub</a>

          <h1 id="project_title">IDES Data Preparation - OpenSSL</h1>
          <h2 id="project_tagline">Decrypting notifications received from IDES with OpenSSL</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/IRSgov/IDES-Data-Preparation-OpenSSL/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/IRSgov/IDES-Data-Preparation-OpenSSL/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a id="ides-data-preparation" class="anchor" href="#ides-data-preparation" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDES Data Preparation</h2>

<p>The International Data Exchange Service (IDES) is a secure managed file transfer service that allows financial institutions and tax authorities to securely send information on financial accounts held by U.S. taxpayers in accordance with the Foreign Account Tax Compliance Act (FATCA). Files transmitted via IDES must be encrypted and packaged in accordance with published data preparation instructions. The data preparation process is an important step to ensure that information transmitted via IDES conforms to U.S security standards to safeguard sensitive information.</p>

<p>The IDES Data Preparation OpenSSL project repository demonstrates the commands necessary to decrypt notifications downloaded from the IDES portal. The included commands are Windows specific, Linux specific, and a process that includes manual editing that will work for those and other systems.</p>

<p>The sample commands are intended to be run from a batch file located along with the OpenSSL executable, the Key and Payload files from the notification, and the receiver's private key. </p>

<p>Please note that there are many open market tools that produce the same results; however, the IRS does not endorse any commercial products, including the frameworks used in the example. </p>

<h3>
<a id="windows-batch-scripting" class="anchor" href="#windows-batch-scripting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Windows Batch Scripting</h3>

<p>The following code should be placed into a batch file and run in the same folder as the openssl executable. </p>

<p>The following files are required and the filename in the batch script will need to be replaced with your filename for each:</p>

<p>KEYFILE - this is the Key file that will be in the downloaded notification .zip file</p>

<p>PRIVATEKEY - this will be your private key that corresponds to the certificate that was uploaded into IDES</p>

<p>PAYLOAD - this is the Payload file that will be in the downloaded notification .zip file</p>

<p>The first command will decrypt the AES key. The batch code will parse the hex values of the AES key and prepare it for the second command. The second command will use the AES key in hex format and decrypt the Payload file. The output will be the decrypted Payload .zip file.</p>

<pre><code>
openssl rsautl -decrypt -hexdump -in KEYFILE -inkey PRIVATEKEY -out aeskey.txt

set /p firstline=&lt; aeskey.txt  
Set line1=%firstline%     
set result1=%line1:~7,48%                           

Setlocal EnableDelayedExpansion
for /f "tokens=* delims= " %%i in (aeskey.txt) do (
set var=%%i
)
set result2=!var:~7,48!  

set result1=%result1: =%
set result1=%result1:-=%
set result1=%result1:~0,32%
set result2=%result2: =%
set result2=%result2:-=%
set result2=%result2:~0,32%
set combined=%result1%%result2%

openssl aes-256-ecb -d -in PAYLOAD -out PAYLOAD.zip -K %combined%


</code></pre>

<p>Running the batch file:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image11.png" alt="Image 1">
Figure 1</p>

<h3>
<a id="linux-shell-scripting" class="anchor" href="#linux-shell-scripting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux Shell Scripting</h3>

<p>Similar to the Windows method above, the following code should be placed into a shell script and run in the same folder as the openssl executable. However, this script will use the cut command to prepare the hex data.</p>

<p>The following files are required and the file names passed to the batch script will need to be replaced with your filename for each:
private_key - this will be your private key that corresponds to the certificate that was uploaded into IDES
key_file - this is the Key file that will be in the downloaded notification .zip file
payload_file - this is the Payload file that will be in the downloaded notification .zip file</p>

<pre><code>private_key=$1 #this will be your private key that corresponds to the certificate that was uploaded into IDES

key_file=$2 #this is the Key file that will be in the downloaded notification .zip file 

payload_file=$3 #this is the Payload file that will be in the downloaded notification .zip file

output_file=$4 #this is the expected output filename, and will be in a .zip format

hexvalue='openssl rsautl -decrypt -hexdump -inkey $private_key_file -in $random_key_file|cut -c-55|cut -c7-55|tr -d "\n"|sed 's/[ -]//g' ';

openssl enc -d -aes-256-ecb -in $payload_file -out $output_file -K $hexvalue
</code></pre>

<p>An example of running the script with the required parameters:</p>

<pre><code>decrypt.sh privatekey.pem 000000.00000.TA.124_Key 000000.00000.TA.840_Payload 000000.00000.TA.840_Payload.zip

</code></pre>

<h3>
<a id="manual-openssl-commands" class="anchor" href="#manual-openssl-commands" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manual OpenSSL Commands</h3>

<p>If you are having trouble with an automated method above, there are additional steps you can take to decrypt the AES key, manually get the required hex key data, and use it to decrypt the Payload file. </p>

<p>The process is similar to the automated method above. The following files are required and the filename in the batch script will need to be replaced with your filename for each:
KEYFILE - this is the Key file that will be in the downloaded notification .zip file
PRIVATEKEY - this will be your private key that corresponds to the certificate that was uploaded into IDES
PAYLOAD - this is the Payload file that will be in the downloaded notification .zip file</p>

<p>The following code should be run in the same folder as the openssl executable and necessary files.</p>

<p>Decrypting the AES key:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image1.png" alt="Image 2">
Figure 2</p>

<p>The hexdump flag in the command above will output the key in hexadecimal format which is needed to decrypt the Payload file. However, there is extra information that is included that needs to be removed before it can be used in the next command. You can use a text editor to open the aeskey.txt file which is the output of the first command.</p>

<p>Example Hex data in Notepad++:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image2.png" alt="Image 3">
Figure 3</p>

<p>Example Hex data in Notepad:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image3.png" alt="Image 4">
Figure 4</p>

<p>The hex content that is needed from the file is bolded below. The rest of the information needs to be removed. </p>

<p>0000 - <strong>e0 a8 fc 55 88 72 3d 5f-24 0f e4 7f 39 42 df a9</strong>   ...U.r=_$...9B..</p>

<p>0010 - <strong>c4 34 ab 26 bb b2 dc 20-65 59 d7 14 cd b0 15 47</strong>   .4.&amp;... eY.....G</p>

<ul>
<li>With the beginning and ending information stripped out.</li>
</ul>

<p><strong>e0 a8 fc 55 88 72 3d 5f-24 0f e4 7f 39 42 df a9</strong></p>

<p><strong>c4 34 ab 26 bb b2 dc 20-65 59 d7 14 cd b0 15 47</strong></p>

<ul>
<li>With the spaces and dashes removed and leftover characters together, the end result is a 64 character string. The string must be exactly 64 characters in length:</li>
</ul>

<p><strong>e0a8fc5588723d5f240fe47f3942dfa9c434ab26bbb2dc206559d714cdb01547</strong></p>

<p>The second command to decrypt the Payload file can then be executed using the 64 character hex key string. The Payload file from the downloaded notification zip file is needed as well as the 64 character hex key string.</p>

<pre><code>openssl aes-256-ecb -d -in 000000.00000.TA.840_Payload -out 000000.00000.TA.840_Payload.zip -K e0a8fc5588723d5f240fe47f3942dfa9c434ab26bbb2dc206559d714cdb01547
</code></pre>

<p>Decrypting the Payload file:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image4.png" alt="Image 5">
Figure 5</p>

<p>This will decrypt the encrypted Payload file giving you the zip file which contains the XML Payload file.</p>

<p>Folder Contents with the Payload .zip file:
<img src="http://irsgov.github.io/IDES-Data-Preparation-OpenSSL/images/image5.png" alt="Image 6">
Figure 6</p>

<h3>
<a id="disclaimer" class="anchor" href="#disclaimer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Disclaimer:</h3>

<p>We waive copyright and related rights in the work worldwide through the CC0 1.0 Universal public domain dedication. Unless expressly stated otherwise, the person who associated a work with this deed makes no warranties about the work, and disclaims liability for all uses of the work, to the fullest extent permitted by applicable law. When using or citing the work, you should not imply endorsement by the author or the affirmer.</p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">IDES Data Preparation - OpenSSL maintained by <a href="https://github.com/IRSgov">IRSgov</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
